<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Dispatch Center - Emergentica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap');
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #0a0e1a;
        }
        
        .pulse-border {
            animation: pulse-border 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse-border {
            0%, 100% {
                border-color: rgba(239, 68, 68, 0.5);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                border-color: rgba(239, 68, 68, 1);
                box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
            }
        }
        
        .emotion-bar {
            transition: width 0.5s ease-out, background-color 0.3s ease;
        }
        
        .transcript-line {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status-blink {
            animation: blink 1.5s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body class="text-gray-100">
    <!-- Main Container -->
    <div class="min-h-screen p-6">
        <!-- Header -->
        <div class="mb-6 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-red-500">EMERGENCY DISPATCH CENTER</h1>
                <p class="text-gray-400 text-sm mt-1">Emergentica Multi-Agent System</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full status-blink"></div>
                    <span class="text-sm text-gray-400">SYSTEM ACTIVE</span>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">LAST UPDATE</div>
                    <div id="lastUpdate" class="text-sm font-semibold text-gray-300">--:--:--</div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="mb-6 border-b border-gray-800">
            <div class="flex space-x-4">
                <button onclick="switchTab('live')" id="tabLive" class="tab-btn px-6 py-3 text-sm font-semibold border-b-2 border-red-500 text-red-500">
                    üö® LIVE DISPATCH
                </button>
                <button onclick="switchTab('benchmark')" id="tabBenchmark" class="tab-btn px-6 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-300">
                    üìä TRACK A PERFORMANCE
                </button>
            </div>
        </div>

        <!-- Live Dispatch View -->
        <div id="liveView">
        <!-- Main Grid -->
        <div class="grid grid-cols-12 gap-6">
            <!-- Left Column: Call Info & Map -->
            <div class="col-span-8 space-y-6">
                <!-- Call Header -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-4">
                                <span id="severityBadge" class="px-4 py-2 rounded-lg text-sm font-bold">
                                    STANDBY
                                </span>
                                <span id="callId" class="text-xs text-gray-500 font-mono">No active call</span>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">INCIDENT TYPE</div>
                                    <div id="incidentType" class="text-lg font-semibold text-gray-200">--</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">LOCATION</div>
                                    <div id="location" class="text-lg font-semibold text-gray-200">--</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">PROCESSING TIME</div>
                                    <div id="processingTime" class="text-lg font-semibold text-gray-200">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Map -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                    <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">Incident Location</h3>
                    <div id="map" class="w-full h-80 bg-gray-800 rounded-lg"></div>
                </div>

                <!-- Transcript -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                    <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">Live Transcript</h3>
                    <div id="transcript" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        <div class="text-gray-600 text-center py-8">Waiting for call data...</div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Emotion & Dispatch Status -->
            <div class="col-span-4 space-y-6">
                <!-- Emotion Analysis -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                    <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">Caller Emotion</h3>
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span id="emotionLabel" class="text-2xl font-bold text-gray-200">CALM</span>
                            <span id="emotionIntensity" class="text-sm text-gray-500">LOW</span>
                        </div>
                        <div class="w-full h-3 bg-gray-800 rounded-full overflow-hidden">
                            <div id="emotionBar" class="emotion-bar h-full bg-green-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="emotionIndicators" class="space-y-2 text-sm text-gray-400">
                        <div class="text-gray-600">No indicators available</div>
                    </div>
                </div>

                <!-- Dispatch Status -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                    <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">Dispatch Status</h3>
                    <div id="dispatchUnits" class="space-y-3">
                        <div class="text-gray-600 text-center py-4">No units dispatched</div>
                    </div>
                </div>

                <!-- Key Facts -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                    <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">Key Facts</h3>
                    <div id="keyFacts" class="space-y-2 text-sm">
                        <div class="text-gray-600">No facts available</div>
                    </div>
                </div>

                <!-- Recommended Actions -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                    <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">Recommended Actions</h3>
                    <div id="recommendedActions" class="space-y-2 text-sm">
                        <div class="text-gray-600">No actions available</div>
                    </div>
                </div>
            </div>
        </div>
        </div> <!-- End Live View -->

        <!-- Benchmark View (Track A Performance) -->
        <div id="benchmarkView" style="display: none;">
            <div class="grid grid-cols-12 gap-6">
                <!-- Main Metrics -->
                <div class="col-span-12">
                    <div class="bg-gradient-to-r from-red-900/20 to-red-800/20 border border-red-800/50 rounded-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold text-red-400 mb-2">üìä Track A: Iron Man Performance</h2>
                        <p class="text-gray-400 text-sm">System benchmarked against 50+ emergency call scenarios</p>
                    </div>
                </div>

                <!-- Key Performance Metrics -->
                <div class="col-span-3">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <div class="text-gray-400 text-xs mb-2 uppercase tracking-wider">Routing Accuracy</div>
                        <div id="benchAccuracy" class="text-4xl font-bold text-green-400 mb-1">96.0%</div>
                        <div class="text-xs text-gray-500">Critical: 98.5% | Standard: 95.2%</div>
                    </div>
                </div>

                <div class="col-span-3">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <div class="text-gray-400 text-xs mb-2 uppercase tracking-wider">Avg Response Time</div>
                        <div id="benchLatency" class="text-4xl font-bold text-blue-400 mb-1">1.59s</div>
                        <div class="text-xs text-gray-500">Router: 847ms | Triage: 2.3s</div>
                    </div>
                </div>

                <div class="col-span-3">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <div class="text-gray-400 text-xs mb-2 uppercase tracking-wider">Cost Efficiency</div>
                        <div id="benchCost" class="text-4xl font-bold text-yellow-400 mb-1">67%</div>
                        <div class="text-xs text-gray-500">vs. Sonnet-only baseline</div>
                    </div>
                </div>

                <div class="col-span-3">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <div class="text-gray-400 text-xs mb-2 uppercase tracking-wider">Calls Tested</div>
                        <div id="benchCalls" class="text-4xl font-bold text-purple-400 mb-1">50</div>
                        <div class="text-xs text-gray-500">Diverse scenarios</div>
                    </div>
                </div>

                <!-- Detailed Breakdown -->
                <div class="col-span-6">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">Performance by Category</h3>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-red-400">Critical Emergency</span>
                                    <span id="criticalAccuracy" class="font-mono text-green-400">98.5%</span>
                                </div>
                                <div class="w-full bg-gray-800 rounded-full h-2">
                                    <div class="bg-red-500 h-2 rounded-full" style="width: 98.5%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-yellow-400">Standard Assistance</span>
                                    <span id="standardAccuracy" class="font-mono text-green-400">95.2%</span>
                                </div>
                                <div class="w-full bg-gray-800 rounded-full h-2">
                                    <div class="bg-yellow-500 h-2 rounded-full" style="width: 95.2%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-blue-400">Non-Emergency</span>
                                    <span id="nonEmergencyAccuracy" class="font-mono text-green-400">94.8%</span>
                                </div>
                                <div class="w-full bg-gray-800 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: 94.8%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Analysis -->
                <div class="col-span-6">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">Cost Analysis</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-400">Total Cost (50 calls)</span>
                                <span id="totalCost" class="font-mono text-green-400">$0.042</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-400">Cost per Call</span>
                                <span id="costPerCall" class="font-mono text-green-400">$0.00084</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-400">Sonnet-Only Baseline</span>
                                <span id="sonnetCost" class="font-mono text-red-400">$0.128</span>
                            </div>
                            <div class="pt-3 border-t border-gray-800 flex justify-between items-center">
                                <span class="text-sm font-bold text-yellow-400">Cost Savings</span>
                                <span id="savings" class="font-mono text-xl font-bold text-yellow-400">67.3%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Model Distribution -->
                <div class="col-span-12">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">Multi-Agent Architecture</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-gray-800/50 rounded-lg p-4 text-center">
                                <div class="text-xs text-gray-500 mb-2">ROUTER AGENT</div>
                                <div class="font-mono text-sm text-blue-400">Claude 3.5 Haiku</div>
                                <div class="text-xs text-gray-600 mt-1">Fast classification</div>
                            </div>
                            <div class="bg-gray-800/50 rounded-lg p-4 text-center">
                                <div class="text-xs text-gray-500 mb-2">TRIAGE AGENT</div>
                                <div class="font-mono text-sm text-red-400">Claude 3.5 Haiku</div>
                                <div class="text-xs text-gray-600 mt-1">Critical analysis</div>
                            </div>
                            <div class="bg-gray-800/50 rounded-lg p-4 text-center">
                                <div class="text-xs text-gray-500 mb-2">INFO AGENT</div>
                                <div class="font-mono text-sm text-green-400">Claude 3.5 Haiku</div>
                                <div class="text-xs text-gray-600 mt-1">Standard handling</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Track A Compliance -->
                <div class="col-span-12">
                    <div class="bg-gradient-to-r from-green-900/20 to-green-800/20 border border-green-800/50 rounded-lg p-6">
                        <h3 class="text-sm font-bold text-green-400 mb-4 uppercase tracking-wider">‚úì Track A: Iron Man Compliance</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="flex items-center space-x-3">
                                <div class="text-3xl">‚ö°</div>
                                <div>
                                    <div class="text-sm font-bold text-green-400">Performance</div>
                                    <div class="text-xs text-gray-400">High accuracy (96%+)</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <div class="text-3xl">üõ°Ô∏è</div>
                                <div>
                                    <div class="text-sm font-bold text-green-400">Robustness</div>
                                    <div class="text-xs text-gray-400">Consistent &lt;3s response</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <div class="text-3xl">üí∞</div>
                                <div>
                                    <div class="text-sm font-bold text-green-400">Cost Efficiency</div>
                                    <div class="text-xs text-gray-400">67% cost reduction</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet Map & Geocoding Script -->
    <script>
        let map;
        let marker;
        let GEOCODE_API_KEY = '';
        let mapInitialized = false;
        
        // Initialize Leaflet map (only once)
        function initMap(lat = 51.5074, lng = -0.1278, address = null) {
            // Only create map if not already initialized
            if (!mapInitialized) {
                // Create map
                map = L.map('map').setView([lat, lng], 15);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                    maxZoom: 19
                }).addTo(map);
                
                mapInitialized = true;
            } else {
                // Map already exists, just update view
                map.setView([lat, lng], 15);
            }
            
            // Remove old marker if exists
            if (marker) {
                map.removeLayer(marker);
            }
            
            // Add new marker
            marker = L.marker([lat, lng]).addTo(map);
            
            if (address) {
                marker.bindPopup(`<b>Incident Location</b><br>${address}`).openPopup();
            }
        }
        
        // Geocode address using geocode.maps.co
        async function geocodeAddress(address) {
            if (!address) {
                console.log('No address available');
                return null;
            }
            
            try {
                // Using geocode.maps.co geocoding API
                const url = GEOCODE_API_KEY 
                    ? `https://geocode.maps.co/search?q=${encodeURIComponent(address)}&api_key=${GEOCODE_API_KEY}`
                    : `https://geocode.maps.co/search?q=${encodeURIComponent(address)}`;
                
                console.log('Geocoding URL:', url);
                const response = await fetch(url);
                
                if (!response.ok) {
                    console.error('Geocoding API error:', response.status, response.statusText);
                    return null;
                }
                
                const data = await response.json();
                console.log('Geocoding response:', data);
                
                if (data && data.length > 0) {
                    console.log('Geocoded to:', data[0]);
                    return { 
                        lat: parseFloat(data[0].lat), 
                        lng: parseFloat(data[0].lon),
                        display_name: data[0].display_name
                    };
                } else {
                    console.log('No geocoding results found');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            return null;
        }
        
        // Load API key from backend
        async function loadConfig() {
            try {
                const response = await fetch('http://localhost:8000/api/config');
                const config = await response.json();
                GEOCODE_API_KEY = config.geocode_api_key || '';
                console.log('Geocode API key loaded:', GEOCODE_API_KEY ? 'Yes' : 'No');
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }
        
        // Update dashboard with call data
        async function updateDashboard() {
            try {
                const response = await fetch('http://localhost:8000/api/latest-call');
                if (!response.ok) {
                    console.log('No call data available');
                    return;
                }
                
                const data = await response.json();
                console.log('Call data:', data);
                
                // Update timestamp
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                
                // Update call header
                document.getElementById('callId').textContent = data.call_id || 'Unknown';
                
                // Update severity badge
                const severityBadge = document.getElementById('severityBadge');
                const severity = data.classification?.severity || 'STANDBY';
                let badgeClass = 'bg-gray-700 text-gray-300';
                
                if (severity === 'CRITICAL_EMERGENCY') {
                    badgeClass = 'bg-red-600 text-white pulse-border border-2';
                } else if (severity === 'STANDARD_ASSISTANCE') {
                    badgeClass = 'bg-yellow-600 text-white';
                } else if (severity === 'NON_EMERGENCY') {
                    badgeClass = 'bg-blue-600 text-white';
                }
                
                severityBadge.className = `px-4 py-2 rounded-lg text-sm font-bold ${badgeClass}`;
                severityBadge.textContent = severity.replace(/_/g, ' ');
                
                // Update incident info
                if (data.critical_report) {
                    document.getElementById('incidentType').textContent = 
                        data.critical_report.incident_type?.replace(/_/g, ' ') || '--';
                    
                    // Extract address from key_facts (look for the one with street/postcode info)
                    let locationText = '--';
                    if (data.critical_report.key_facts) {
                        // Find the key fact that contains address info (street, postcode, etc.)
                        const addressFact = data.critical_report.key_facts.find(fact => 
                            fact.toLowerCase().includes('street') || 
                            fact.toLowerCase().includes('road') || 
                            fact.toLowerCase().includes('located at') ||
                            fact.toLowerCase().includes('postcode') ||
                            /[A-Z]\d{1,2}\s?\d[A-Z]{2}/i.test(fact) // UK postcode pattern
                        );
                        
                        if (addressFact) {
                            // Extract just the address part if it says "Located at..."
                            locationText = addressFact.replace(/^Located at /i, '').trim();
                        } else {
                            // Fallback to first key fact
                            locationText = data.critical_report.key_facts[0];
                        }
                    }
                    
                    // Fallback to location fields
                    if (!locationText || locationText === '--') {
                        locationText = data.critical_report.location?.address || 
                                     data.critical_report.location?.landmark || '--';
                    }
                    
                    document.getElementById('location').textContent = locationText;
                    
                    // Update map with geocoding
                    if (locationText !== '--' && locationText.length > 5) {
                        console.log('Attempting to geocode:', locationText);
                        const coords = await geocodeAddress(locationText);
                        if (coords) {
                            console.log('Successfully geocoded to:', coords);
                            initMap(coords.lat, coords.lng, coords.display_name || locationText);
                        } else {
                            console.log('Geocoding failed for:', locationText);
                        }
                    }
                } else if (data.info_response) {
                    document.getElementById('incidentType').textContent = 
                        data.info_response.call_type || '--';
                    document.getElementById('location').textContent = 
                        data.info_response.address || data.info_response.postcode || '--';
                }
                
                document.getElementById('processingTime').textContent = 
                    data.processing_time_ms ? `${(data.processing_time_ms / 1000).toFixed(2)}s` : '--';
                
                // Update transcript
                const transcriptDiv = document.getElementById('transcript');
                if (data.transcript) {
                    const lines = data.transcript.split('\n\n');
                    transcriptDiv.innerHTML = lines.map(line => {
                        const isCaller = line.startsWith('Caller:');
                        const isDispatcher = line.startsWith('Dispatcher:');
                        
                        if (isCaller) {
                            return `
                                <div class="transcript-line bg-blue-900/30 border-l-4 border-blue-500 p-3 rounded">
                                    <div class="text-xs text-blue-400 font-bold mb-1">CALLER</div>
                                    <div class="text-sm text-gray-200">${line.replace('Caller:', '').trim()}</div>
                                </div>
                            `;
                        } else if (isDispatcher) {
                            return `
                                <div class="transcript-line bg-green-900/30 border-l-4 border-green-500 p-3 rounded">
                                    <div class="text-xs text-green-400 font-bold mb-1">DISPATCHER</div>
                                    <div class="text-sm text-gray-200">${line.replace('Dispatcher:', '').trim()}</div>
                                </div>
                            `;
                        }
                        return '';
                    }).join('');
                }
                
                // Update emotion
                if (data.critical_report?.emotion || data.info_response?.caller_emotion) {
                    const emotion = data.critical_report?.emotion || {
                        primary_emotion: data.info_response.caller_emotion,
                        intensity: data.info_response.emotion_intensity,
                        indicators: []
                    };
                    
                    const emotionLabel = emotion.primary_emotion || 'CALM';
                    const intensity = emotion.intensity || 'LOW';
                    
                    document.getElementById('emotionLabel').textContent = emotionLabel;
                    document.getElementById('emotionIntensity').textContent = intensity;
                    
                    // Emotion bar
                    const emotionBar = document.getElementById('emotionBar');
                    let percentage = 0;
                    let barColor = 'bg-green-500';
                    
                    if (intensity === 'LOW') {
                        percentage = 33;
                        barColor = 'bg-green-500';
                    } else if (intensity === 'MEDIUM') {
                        percentage = 66;
                        barColor = 'bg-yellow-500';
                    } else if (intensity === 'HIGH' || intensity === 'EXTREME') {
                        percentage = 100;
                        barColor = 'bg-red-500';
                    }
                    
                    emotionBar.style.width = `${percentage}%`;
                    emotionBar.className = `emotion-bar h-full ${barColor}`;
                    
                    // Indicators
                    if (emotion.indicators && emotion.indicators.length > 0) {
                        document.getElementById('emotionIndicators').innerHTML = emotion.indicators
                            .map(ind => `<div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                <span>${ind}</span>
                            </div>`).join('');
                    }
                }
                
                // Update dispatch units
                if (data.critical_report?.resources) {
                    const resources = data.critical_report.resources;
                    const units = [];
                    
                    if (resources.police) units.push({ name: 'POLICE', color: 'blue' });
                    if (resources.fire) units.push({ name: 'FIRE', color: 'red' });
                    if (resources.ambulance) units.push({ name: 'AMBULANCE', color: 'green' });
                    if (resources.swat) units.push({ name: 'SWAT', color: 'purple' });
                    if (resources.negotiator) units.push({ name: 'NEGOTIATOR', color: 'yellow' });
                    
                    if (units.length > 0) {
                        document.getElementById('dispatchUnits').innerHTML = units.map(unit => `
                            <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-3 h-3 bg-${unit.color}-500 rounded-full status-blink"></div>
                                    <span class="font-semibold">${unit.name}</span>
                                </div>
                                <span class="text-xs text-gray-500">EN ROUTE</span>
                            </div>
                        `).join('');
                        
                        if (resources.additional_units > 0) {
                            document.getElementById('dispatchUnits').innerHTML += `
                                <div class="text-sm text-gray-400 text-center">
                                    +${resources.additional_units} additional units
                                </div>
                            `;
                        }
                    }
                }
                
                // Update key facts
                if (data.critical_report?.key_facts) {
                    document.getElementById('keyFacts').innerHTML = data.critical_report.key_facts
                        .map(fact => `<div class="flex items-start space-x-2">
                            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full mt-1.5"></div>
                            <span class="text-gray-300">${fact}</span>
                        </div>`).join('');
                }
                
                // Update recommended actions
                if (data.critical_report?.recommended_actions) {
                    document.getElementById('recommendedActions').innerHTML = data.critical_report.recommended_actions
                        .map((action, i) => `<div class="flex items-start space-x-2">
                            <div class="text-yellow-500 font-bold">${i + 1}.</div>
                            <span class="text-gray-300">${action}</span>
                        </div>`).join('');
                }
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }
        
        // Tab Switching
        function switchTab(tab) {
            const liveView = document.getElementById('liveView');
            const benchmarkView = document.getElementById('benchmarkView');
            const tabLive = document.getElementById('tabLive');
            const tabBenchmark = document.getElementById('tabBenchmark');
            
            if (tab === 'live') {
                liveView.style.display = 'block';
                benchmarkView.style.display = 'none';
                tabLive.className = 'tab-btn px-6 py-3 text-sm font-semibold border-b-2 border-red-500 text-red-500';
                tabBenchmark.className = 'tab-btn px-6 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-300';
            } else if (tab === 'benchmark') {
                liveView.style.display = 'none';
                benchmarkView.style.display = 'block';
                tabLive.className = 'tab-btn px-6 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-300';
                tabBenchmark.className = 'tab-btn px-6 py-3 text-sm font-semibold border-b-2 border-red-500 text-red-500';
                loadBenchmarkData();
            }
        }
        
        // Load Benchmark Data
        async function loadBenchmarkData() {
            try {
                const response = await fetch('/api/benchmark');
                const data = await response.json();
                
                // Update metrics
                document.getElementById('benchAccuracy').textContent = `${data.routing_accuracy}%`;
                document.getElementById('benchLatency').textContent = `${(data.avg_response_time_ms / 1000).toFixed(2)}s`;
                document.getElementById('benchCost').textContent = `${data.cost_efficiency_vs_sonnet}%`;
                document.getElementById('benchCalls').textContent = data.total_calls_tested;
                
                // Update category accuracies
                document.getElementById('criticalAccuracy').textContent = `${data.performance_metrics.critical_emergency_accuracy}%`;
                document.getElementById('standardAccuracy').textContent = `${data.performance_metrics.standard_assistance_accuracy}%`;
                document.getElementById('nonEmergencyAccuracy').textContent = `${data.performance_metrics.non_emergency_accuracy}%`;
                
                // Update cost breakdown
                document.getElementById('totalCost').textContent = `$${data.cost_breakdown.total_cost_usd.toFixed(3)}`;
                document.getElementById('costPerCall').textContent = `$${data.cost_breakdown.cost_per_call_usd.toFixed(5)}`;
                document.getElementById('sonnetCost').textContent = `$${data.cost_breakdown.vs_sonnet_only_usd.toFixed(3)}`;
                document.getElementById('savings').textContent = `${data.cost_breakdown.savings_percentage}%`;
                
            } catch (error) {
                console.error('Error loading benchmark data:', error);
            }
        }
        
        // Initialize
        async function init() {
            await loadConfig();
            initMap();
            updateDashboard();
            
            // Auto-refresh every 2 seconds
            setInterval(updateDashboard, 2000);
        }
        
        init();
    </script>
</body>
</html>
